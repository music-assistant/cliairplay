name: Build cliap2 for all supported platforms

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

jobs:
  linux-aarch64:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          submodules: recursive

      - name: Containerised Build
        run: |
          docker build --build-arg TARGETARCH=linux-aarch64 --output type=local,dest=. .
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cliap2-linux-aarch64
          path: ${{ github.workspace }}



  linux-x86_64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          submodules: recursive

      - name: Containerised Build
        run: |
          docker build --build-arg TARGETARCH=linux-x86_64 --output type=local,dest=. .

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cliap2-linux-x86_64
          path: ${{ github.workspace }}


  macos:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install build dependencies
        run: |
          brew install git autoconf automake libtool pkgconf gettext gawk \
          confuse libunistring ffmpeg libxml2 libgcrypt zlib libevent libplist \
          libiconv libsodium json-c curl openssl@3 protobuf-c bison

      - name: Apply FFmpeg 8.0 compatibility patch
        run: |
          patch -p1 < patches/ffmpeg8.patch || cat owntone-server/src/transcode.c.rej

      - name: Build for macOS ARM64
        run: |
          export BREW_PREFIX="$(brew --prefix)"
          export OPENSSL_PREFIX="$(brew --prefix openssl@3)"
          export LIBXML2_PREFIX="$(brew --prefix libxml2)"
          export ZLIB_PREFIX="$(brew --prefix zlib)"
          export LIBGCRYPT_PREFIX="$(brew --prefix libgcrypt)"
          export LIBGPG_ERROR_PREFIX="$(brew --prefix libgpg-error)"
          export LIBUNISTRING_PREFIX="$(brew --prefix libunistring)"
          export LIBICONV_PREFIX="$(brew --prefix libiconv)"

          export PKG_CONFIG_PATH="$LIBXML2_PREFIX/lib/pkgconfig:$ZLIB_PREFIX/lib/pkgconfig:$LIBGCRYPT_PREFIX/lib/pkgconfig:$LIBGPG_ERROR_PREFIX/lib/pkgconfig:$PKG_CONFIG_PATH"
          export LDFLAGS="-L$LIBXML2_PREFIX/lib -L$ZLIB_PREFIX/lib -L$LIBGCRYPT_PREFIX/lib -L$LIBGPG_ERROR_PREFIX/lib -L$LIBICONV_PREFIX/lib"
          export CPPFLAGS="-I$OPENSSL_PREFIX/include -I$LIBXML2_PREFIX/include -I$ZLIB_PREFIX/include -I$LIBGCRYPT_PREFIX/include -I$LIBGPG_ERROR_PREFIX/include -I$LIBICONV_PREFIX/include"
          export LIBUNISTRING_CFLAGS="-I$LIBUNISTRING_PREFIX/include"
          export LIBUNISTRING_LIBS="-L$LIBUNISTRING_PREFIX/lib -lunistring -L$LIBICONV_PREFIX/lib -liconv"
          export PATH="$BREW_PREFIX/opt/bison/bin:$PATH"
          export ACLOCAL_PATH="$BREW_PREFIX/share/gettext/m4"

          export LIBS="$OPENSSL_PREFIX/lib/libssl.a $OPENSSL_PREFIX/lib/libcrypto.a"

          autoreconf -fi
          ./configure || { echo "Configure failed, showing config.log:"; tail -100 config.log; exit 1; }
          make -j$(sysctl -n hw.ncpu)
          mkdir -p release
          cp src/cliap2 release/cliap2-macos-arm64
          chmod +x release/cliap2-macos-arm64
          # Show dependencies - verify OpenSSL is statically linked
          echo "=== Binary dependencies ==="
          otool -L release/cliap2-macos-arm64
          echo "=== Checking for OpenSSL symbols ==="
          nm release/cliap2-macos-arm64 | grep -i ssl | head -10 || echo "OpenSSL symbols found (statically linked)"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cliap2-macos-arm64
          path: release/

  create-release:
    needs: [linux-x86_64, linux-aarch64, macos]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.sha }}
          name: Automated Build ${{ github.sha }}
          draft: false
          prerelease: true
          files: |
            artifacts/cliap2-linux-x86_64/cliap2-linux-x86_64
            artifacts/cliap2-linux-aarch64/cliap2-linux-aarch64
            artifacts/cliap2-macos-arm64/cliap2-macos-arm64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
